<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendrier Humeur & Sommeil</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @media print {
            body { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            .no-print { display: none !important; }
            .print-break { page-break-before: always; }
            .break-inside-avoid { break-inside: avoid; }
            input, textarea { border: none !important; background: transparent !important; resize: none; }
            input::placeholder, textarea::placeholder { color: transparent; }
            .shadow-xl { box-shadow: none !important; }
            .day-cell { padding: 4px !important; }
            .day-cell input { font-size: 10px !important; padding: 1px !important; }
            .day-cell textarea { font-size: 9px !important; min-height: 30px !important; }
        }

        .mood-indicator {
            transition: all 0.2s;
        }

        .day-cell {
            min-height: 120px;
        }

        @media (max-width: 768px) {
            .day-cell {
                min-height: 100px;
            }
        }

        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans min-h-screen text-gray-800">

    <!-- Barre d'outils (Masquée à l'impression) -->
    <div class="no-print sticky top-0 z-50 bg-white border-b shadow-md p-4 mb-6">
        <div class="max-w-6xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-4">
                <a href="index.html" class="p-2 hover:bg-slate-100 rounded-full transition-colors">
                    <i data-lucide="arrow-left" class="w-5 h-5 text-slate-600"></i>
                </a>
                <div class="flex items-center gap-2">
                    <div class="bg-amber-500 p-2 rounded-lg text-white">
                        <i data-lucide="calendar-heart"></i>
                    </div>
                    <h1 class="text-xl font-bold text-gray-800">Calendrier Humeur & Sommeil</h1>
                </div>
            </div>

            <div class="flex gap-3">
                <button onclick="resetForm()" class="flex items-center gap-2 px-4 py-2 text-sm font-medium text-red-600 bg-red-50 hover:bg-red-100 rounded-lg transition-colors">
                    <i data-lucide="rotate-ccw" width="16"></i> Réinitialiser
                </button>
                <button onclick="window.print()" class="flex items-center gap-2 px-6 py-2 text-sm font-bold text-white bg-amber-500 hover:bg-amber-600 rounded-lg shadow-sm transition-colors">
                    <i data-lucide="printer" width="16"></i> Imprimer / PDF
                </button>
            </div>
        </div>
    </div>

    <!-- Document Principal -->
    <div class="max-w-6xl mx-auto p-4 md:p-8 bg-white shadow-xl mb-10 print:shadow-none print:p-4 print:mb-0">

        <!-- En-tête -->
        <div class="border-b-4 border-gray-800 pb-6 mb-6">
            <div class="flex justify-between items-start mb-6">
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold text-gray-900 mb-1">Calendrier de Suivi</h1>
                    <p class="text-gray-500 text-sm uppercase tracking-wide">Humeur, Sommeil & Événements</p>
                </div>
                <div class="text-right hidden print:block">
                    <div class="text-xs text-gray-400" id="print-date"></div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 bg-gray-50 p-4 md:p-6 rounded-lg border border-gray-200 print:bg-white print:border-gray-300">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1 flex items-center gap-1">
                        <i data-lucide="user" width="12"></i> Nom du Patient
                    </label>
                    <input type="text" id="patient-name" placeholder="Nom Prénom" class="w-full bg-white border border-gray-300 rounded p-2 outline-none focus:ring-2 focus:ring-amber-500 font-medium text-lg print:p-0">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1 flex items-center gap-1">
                        <i data-lucide="calendar" width="12"></i> Mois / Année
                    </label>
                    <input type="month" id="month-selector" class="w-full bg-white border border-gray-300 rounded p-2 outline-none focus:ring-2 focus:ring-amber-500 print:p-0">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Prochain RDV</label>
                    <input type="date" id="next-appointment" class="w-full bg-white border border-gray-300 rounded p-2 outline-none focus:ring-2 focus:ring-amber-500 print:p-0">
                </div>
            </div>
        </div>

        <!-- Légende -->
        <div class="mb-4 p-4 bg-amber-50 rounded-lg border border-amber-200 print:bg-white print:border-gray-300">
            <div class="flex flex-wrap gap-4 md:gap-8 text-sm">
                <div class="flex items-center gap-2">
                    <i data-lucide="smile" class="w-4 h-4 text-amber-600"></i>
                    <span><strong>Humeur</strong> : 0 (très mal) à 10 (excellent)</span>
                </div>
                <div class="flex items-center gap-2">
                    <i data-lucide="moon" class="w-4 h-4 text-indigo-600"></i>
                    <span><strong>Sommeil</strong> : heures + qualité (0-10)</span>
                </div>
                <div class="flex items-center gap-2">
                    <i data-lucide="file-text" class="w-4 h-4 text-gray-600"></i>
                    <span><strong>Notes</strong> : événements, traitements si besoin</span>
                </div>
            </div>
        </div>

        <!-- Navigation Mois (Masquée à l'impression) -->
        <div class="no-print flex justify-between items-center mb-4">
            <button onclick="previousMonth()" class="flex items-center gap-1 px-3 py-2 text-sm font-medium text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">
                <i data-lucide="chevron-left" width="16"></i> Mois précédent
            </button>
            <h2 id="month-title" class="text-xl font-bold text-gray-800"></h2>
            <button onclick="nextMonth()" class="flex items-center gap-1 px-3 py-2 text-sm font-medium text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">
                Mois suivant <i data-lucide="chevron-right" width="16"></i>
            </button>
        </div>

        <!-- Titre mois pour impression -->
        <h2 id="month-title-print" class="hidden print:block text-xl font-bold text-gray-800 text-center mb-4"></h2>

        <!-- Calendrier -->
        <div class="border border-gray-300 rounded-lg overflow-hidden">
            <!-- En-têtes jours -->
            <div class="grid grid-cols-7 bg-gray-800 text-white text-center text-xs md:text-sm font-bold">
                <div class="p-2 border-r border-gray-700">Lun</div>
                <div class="p-2 border-r border-gray-700">Mar</div>
                <div class="p-2 border-r border-gray-700">Mer</div>
                <div class="p-2 border-r border-gray-700">Jeu</div>
                <div class="p-2 border-r border-gray-700">Ven</div>
                <div class="p-2 border-r border-gray-700 bg-gray-700">Sam</div>
                <div class="p-2 bg-gray-700">Dim</div>
            </div>

            <!-- Grille des jours -->
            <div id="calendar-grid" class="grid grid-cols-7">
                <!-- Généré par JS -->
            </div>
        </div>

        <!-- Résumé Mensuel -->
        <div class="mt-8 border-t-2 border-gray-300 pt-6 break-inside-avoid">
            <h3 class="text-xl font-bold text-gray-900 mb-4">Résumé du Mois</h3>

            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-amber-50 rounded-xl p-4 border border-amber-200 text-center print:bg-white print:border-gray-300">
                    <div class="text-xs font-bold text-amber-600 uppercase mb-1">Humeur Moyenne</div>
                    <div id="avg-mood" class="text-3xl font-bold text-amber-700">-</div>
                    <div class="text-xs text-gray-500">/10</div>
                </div>
                <div class="bg-indigo-50 rounded-xl p-4 border border-indigo-200 text-center print:bg-white print:border-gray-300">
                    <div class="text-xs font-bold text-indigo-600 uppercase mb-1">Sommeil Moyen</div>
                    <div id="avg-sleep" class="text-3xl font-bold text-indigo-700">-</div>
                    <div class="text-xs text-gray-500">heures</div>
                </div>
                <div class="bg-violet-50 rounded-xl p-4 border border-violet-200 text-center print:bg-white print:border-gray-300">
                    <div class="text-xs font-bold text-violet-600 uppercase mb-1">Qualité Sommeil</div>
                    <div id="avg-quality" class="text-3xl font-bold text-violet-700">-</div>
                    <div class="text-xs text-gray-500">/10</div>
                </div>
                <div class="bg-gray-50 rounded-xl p-4 border border-gray-200 text-center print:bg-white print:border-gray-300">
                    <div class="text-xs font-bold text-gray-600 uppercase mb-1">Jours Renseignés</div>
                    <div id="days-filled" class="text-3xl font-bold text-gray-700">0</div>
                    <div id="days-total" class="text-xs text-gray-500">/31</div>
                </div>
            </div>

            <!-- Graphique simplifié des humeurs -->
            <div class="mb-6">
                <h4 class="font-bold text-gray-700 mb-3 text-sm uppercase">Évolution de l'humeur</h4>
                <div id="mood-chart" class="flex items-end gap-1 h-20 bg-gray-50 rounded p-2 border border-gray-200 overflow-x-auto">
                    <!-- Barres générées par JS -->
                </div>
                <div class="flex justify-between text-xs text-gray-400 mt-1 px-2">
                    <span>1</span>
                    <span id="chart-mid"></span>
                    <span id="chart-end"></span>
                </div>
            </div>

            <!-- Notes importantes du mois -->
            <div class="mb-6">
                <label class="block text-sm font-bold text-gray-700 mb-2">Notes / Observations pour le praticien</label>
                <textarea id="monthly-notes" class="w-full p-4 border border-gray-300 rounded-lg min-h-[100px] print:border print:border-gray-400" placeholder="Événements marquants, effets secondaires, questions pour la consultation..."></textarea>
            </div>

            <!-- Zone traitement si besoin -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6 print:bg-white print:border-gray-300">
                <h4 class="font-bold text-blue-800 mb-3 flex items-center gap-2">
                    <i data-lucide="pill" width="16"></i> Traitements "si besoin" pris ce mois
                </h4>
                <textarea id="prn-summary" class="w-full p-3 border border-blue-200 rounded bg-white min-h-[80px] print:border-gray-300" placeholder="Ex: Xanax 0.25mg x3 (insomnie), Lysanxia 10mg x2 (anxiété)..."></textarea>
            </div>

            <div class="mt-8 pt-8 border-t border-gray-200 flex flex-col md:flex-row justify-between gap-8 text-sm print:mt-12">
                <div class="text-center">
                    <div class="mb-8 font-bold">Date et Signature du Patient</div>
                    <div class="w-48 border-b border-gray-400 mx-auto"></div>
                </div>
                <div class="text-center">
                    <div class="mb-8 font-bold">Observations du Praticien</div>
                    <div class="w-64 border-b border-gray-400 mx-auto"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Logique JavaScript -->
    <script>
        // État global
        let currentDate = new Date();
        let data = {}; // { "2025-01": { "1": { mood: 7, sleepHours: 7, sleepQuality: 6, notes: "..." }, ... } }

        const monthNames = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin',
                           'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'];

        function getMonthKey(date) {
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        }

        function getDaysInMonth(date) {
            return new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
        }

        function getFirstDayOfMonth(date) {
            const day = new Date(date.getFullYear(), date.getMonth(), 1).getDay();
            // Convertir dimanche (0) en 7 pour commencer par lundi
            return day === 0 ? 7 : day;
        }

        function getMoodColor(mood) {
            if (mood === null || mood === undefined || mood === '') return 'bg-gray-200';
            const m = parseInt(mood);
            if (m <= 2) return 'bg-red-400';
            if (m <= 4) return 'bg-orange-400';
            if (m <= 6) return 'bg-yellow-400';
            if (m <= 8) return 'bg-lime-400';
            return 'bg-green-400';
        }

        function renderCalendar() {
            const monthKey = getMonthKey(currentDate);
            const daysInMonth = getDaysInMonth(currentDate);
            const firstDay = getFirstDayOfMonth(currentDate);

            // Initialiser les données du mois si nécessaire
            if (!data[monthKey]) {
                data[monthKey] = {};
            }

            // Mettre à jour les titres
            const monthTitle = `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
            document.getElementById('month-title').textContent = monthTitle;
            document.getElementById('month-title-print').textContent = monthTitle;
            document.getElementById('month-selector').value = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}`;

            // Générer la grille
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';

            // Cellules vides avant le premier jour
            for (let i = 1; i < firstDay; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'bg-gray-50 border-r border-b border-gray-200 min-h-[120px]';
                grid.appendChild(emptyCell);
            }

            // Jours du mois
            for (let day = 1; day <= daysInMonth; day++) {
                const dayData = data[monthKey][day] || {};
                const isWeekend = ((firstDay + day - 2) % 7) >= 5;

                const cell = document.createElement('div');
                cell.className = `day-cell border-r border-b border-gray-200 p-2 ${isWeekend ? 'bg-gray-50' : 'bg-white'} relative`;

                const moodColor = getMoodColor(dayData.mood);

                cell.innerHTML = `
                    <div class="flex justify-between items-start mb-1">
                        <span class="font-bold text-gray-800 text-sm">${day}</span>
                        <div class="mood-indicator w-3 h-3 rounded-full ${moodColor}" title="Humeur: ${dayData.mood ?? '-'}"></div>
                    </div>

                    <div class="space-y-1 text-xs">
                        <!-- Humeur -->
                        <div class="flex items-center gap-1">
                            <i data-lucide="smile" class="w-3 h-3 text-amber-500 flex-shrink-0"></i>
                            <input type="number" min="0" max="10"
                                   value="${dayData.mood ?? ''}"
                                   onchange="updateDay(${day}, 'mood', this.value)"
                                   class="w-full border border-gray-200 rounded px-1 py-0.5 focus:ring-1 focus:ring-amber-500 focus:outline-none"
                                   placeholder="0-10">
                        </div>

                        <!-- Sommeil heures -->
                        <div class="flex items-center gap-1">
                            <i data-lucide="moon" class="w-3 h-3 text-indigo-500 flex-shrink-0"></i>
                            <input type="number" min="0" max="24" step="0.5"
                                   value="${dayData.sleepHours ?? ''}"
                                   onchange="updateDay(${day}, 'sleepHours', this.value)"
                                   class="w-full border border-gray-200 rounded px-1 py-0.5 focus:ring-1 focus:ring-indigo-500 focus:outline-none"
                                   placeholder="heures">
                        </div>

                        <!-- Qualité sommeil -->
                        <div class="flex items-center gap-1">
                            <i data-lucide="star" class="w-3 h-3 text-violet-500 flex-shrink-0"></i>
                            <input type="number" min="0" max="10"
                                   value="${dayData.sleepQuality ?? ''}"
                                   onchange="updateDay(${day}, 'sleepQuality', this.value)"
                                   class="w-full border border-gray-200 rounded px-1 py-0.5 focus:ring-1 focus:ring-violet-500 focus:outline-none"
                                   placeholder="qual.">
                        </div>

                        <!-- Notes -->
                        <textarea onchange="updateDay(${day}, 'notes', this.value)"
                                  class="w-full border border-gray-200 rounded px-1 py-0.5 text-xs resize-none focus:ring-1 focus:ring-gray-400 focus:outline-none"
                                  rows="2"
                                  placeholder="Notes...">${dayData.notes ?? ''}</textarea>
                    </div>
                `;

                grid.appendChild(cell);
            }

            // Cellules vides après le dernier jour pour compléter la grille
            const totalCells = firstDay - 1 + daysInMonth;
            const remainingCells = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
            for (let i = 0; i < remainingCells; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'bg-gray-50 border-r border-b border-gray-200 min-h-[120px]';
                grid.appendChild(emptyCell);
            }

            // Mettre à jour les statistiques
            updateStats();

            // Réinitialiser les icônes Lucide
            lucide.createIcons();
        }

        function updateDay(day, field, value) {
            const monthKey = getMonthKey(currentDate);
            if (!data[monthKey]) data[monthKey] = {};
            if (!data[monthKey][day]) data[monthKey][day] = {};

            if (field === 'mood' || field === 'sleepHours' || field === 'sleepQuality') {
                data[monthKey][day][field] = value === '' ? null : parseFloat(value);
            } else {
                data[monthKey][day][field] = value;
            }

            // Mettre à jour l'indicateur de couleur
            if (field === 'mood') {
                const cells = document.querySelectorAll('.day-cell');
                const cellIndex = day - 1 + getFirstDayOfMonth(currentDate) - 1;
                if (cells[cellIndex]) {
                    const indicator = cells[cellIndex].querySelector('.mood-indicator');
                    if (indicator) {
                        indicator.className = `mood-indicator w-3 h-3 rounded-full ${getMoodColor(value)}`;
                    }
                }
            }

            updateStats();
        }

        function updateStats() {
            const monthKey = getMonthKey(currentDate);
            const monthData = data[monthKey] || {};
            const daysInMonth = getDaysInMonth(currentDate);

            let moodSum = 0, moodCount = 0;
            let sleepSum = 0, sleepCount = 0;
            let qualitySum = 0, qualityCount = 0;
            let daysFilled = 0;

            for (let day = 1; day <= daysInMonth; day++) {
                const dayData = monthData[day];
                if (dayData) {
                    if (dayData.mood !== null && dayData.mood !== undefined) {
                        moodSum += dayData.mood;
                        moodCount++;
                    }
                    if (dayData.sleepHours !== null && dayData.sleepHours !== undefined) {
                        sleepSum += dayData.sleepHours;
                        sleepCount++;
                    }
                    if (dayData.sleepQuality !== null && dayData.sleepQuality !== undefined) {
                        qualitySum += dayData.sleepQuality;
                        qualityCount++;
                    }
                    if (dayData.mood !== null || dayData.sleepHours !== null || dayData.notes) {
                        daysFilled++;
                    }
                }
            }

            // Afficher les moyennes
            document.getElementById('avg-mood').textContent = moodCount > 0 ? (moodSum / moodCount).toFixed(1) : '-';
            document.getElementById('avg-sleep').textContent = sleepCount > 0 ? (sleepSum / sleepCount).toFixed(1) : '-';
            document.getElementById('avg-quality').textContent = qualityCount > 0 ? (qualitySum / qualityCount).toFixed(1) : '-';
            document.getElementById('days-filled').textContent = daysFilled;
            document.getElementById('days-total').textContent = `/${daysInMonth}`;

            // Graphique des humeurs
            renderMoodChart(monthData, daysInMonth);
        }

        function renderMoodChart(monthData, daysInMonth) {
            const chart = document.getElementById('mood-chart');
            chart.innerHTML = '';

            for (let day = 1; day <= daysInMonth; day++) {
                const dayData = monthData[day];
                const mood = dayData?.mood;

                const bar = document.createElement('div');
                bar.className = 'flex-1 min-w-[8px] rounded-t transition-all';

                if (mood !== null && mood !== undefined) {
                    const height = (mood / 10) * 100;
                    bar.style.height = `${Math.max(height, 5)}%`;
                    bar.className += ` ${getMoodColor(mood)}`;
                    bar.title = `Jour ${day}: ${mood}/10`;
                } else {
                    bar.style.height = '5%';
                    bar.className += ' bg-gray-200';
                    bar.title = `Jour ${day}: non renseigné`;
                }

                chart.appendChild(bar);
            }

            // Mettre à jour les labels
            document.getElementById('chart-mid').textContent = Math.ceil(daysInMonth / 2);
            document.getElementById('chart-end').textContent = daysInMonth;
        }

        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        }

        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        }

        function onMonthSelect() {
            const value = document.getElementById('month-selector').value;
            if (value) {
                const [year, month] = value.split('-');
                currentDate = new Date(parseInt(year), parseInt(month) - 1, 1);
                renderCalendar();
            }
        }

        function resetForm() {
            if (confirm("Effacer toutes les données de ce mois ?")) {
                const monthKey = getMonthKey(currentDate);
                data[monthKey] = {};
                document.getElementById('monthly-notes').value = '';
                document.getElementById('prn-summary').value = '';
                renderCalendar();
            }
        }

        // Initialisation
        window.onload = function() {
            // Définir la date actuelle
            currentDate = new Date();

            // Initialiser le sélecteur de mois
            document.getElementById('month-selector').addEventListener('change', onMonthSelect);

            // Date d'impression
            document.getElementById('print-date').textContent = "Généré le " + new Date().toLocaleDateString('fr-FR');

            // Rendu initial
            renderCalendar();

            // Initialiser Lucide
            lucide.createIcons();
        };
    </script>
</body>
</html>
